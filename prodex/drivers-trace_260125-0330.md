*Generated by [Prodex](https://github.com/emxhive/prodex#readme)*
> Note for LLMs: `Lx-Ly` ranges refer to lines in this Prodex trace file, not the original source files. Index metadata is provided via the HTML comment markers in this section.

# Index
<!-- PRODEX_INDEX_RANGE: L8-L12 -->
<!-- PRODEX_FILE_COUNT: 5 -->
<!-- PRODEX_INDEX_LIST_START -->
- [src/Driver/AbstractServiceDriver.php](#1)  L16-L87
- [src/Driver/DriverContext.php](#2)  L88-L128
- [src/Driver/DriverManager.php](#3)  L129-L196
- [src/Driver/DriverRegistry.php](#4)  L197-L353
- [src/Driver/DriverResolver.php](#5)  L354-L383
<!-- PRODEX_INDEX_LIST_END -->

---
---
#### 1


` File: src/Driver/AbstractServiceDriver.php`  [↑ Back to top](#index)

```php
<?php
declare(strict_types=1);

namespace Dgp\Sdk\Driver;

use Throwable;
use Dgp\Sdk\Support\Result;
use Dgp\Sdk\Support\DgpError;
use Dgp\Sdk\Support\DgpErrorCode;
use Dgp\Sdk\Contracts\Ops\HealthCheckContract;
use Dgp\Sdk\Payloads\Requests\Ops\HealthCheckRequest;
use Dgp\Sdk\Payloads\Responses\Ops\HealthCheckResponse;
use Dgp\Sdk\Types\Ops\HealthState;
use Dgp\Sdk\Support\Exceptions\RateLimitedException;

abstract readonly class AbstractServiceDriver implements HealthCheckContract
{
    public function __construct(
        protected DriverContext $context,
    ) {}

    protected function ok(mixed $value): Result
    {
        return Result::ok($value);
    }

    protected function fail(DgpError $error): Result
    {
        return Result::fail($error);
    }

    /**
     * Wrap internal exceptions into Result failures.
     * Drivers can still throw internally; Manager/base converts.
     */
    protected function wrap(callable $fn): Result
    {
        try {
            $res = $fn();
            return $res instanceof Result ? $res : Result::fail(DgpError::unknown('Driver returned non-Result'));
        } catch (RateLimitedException $e) {
            return Result::fail(new DgpError(
                DgpErrorCode::RATE_LIMITED,
                $e->getMessage(),
                null,
                null,
                null,
                $e->retryAfterSeconds,
            ));
        } catch (Throwable $e) {
            return Result::fail(DgpError::fromThrowable($e, DgpErrorCode::UNKNOWN));
        }
    }

    public function healthCheck(HealthCheckRequest $request): Result
    {
        return $this->wrap(function () {
            // Default: if we can reach here, we are at least "unknown/ok".
            // Drivers can override for deeper checks.
            return Result::ok(new HealthCheckResponse(HealthState::OK, 'ok'));
        });
    }
}
```

---
#### 2


` File: src/Driver/DriverContext.php`  [↑ Back to top](#index)

```php
<?php
declare(strict_types=1);

namespace Dgp\Sdk\Driver;

use Dgp\Sdk\Contracts\Infra\TransportContract;
use Dgp\Sdk\Payloads\Common\ProviderConfig;

final readonly class DriverContext
{
    public function __construct(
        public ProviderConfig    $config,
        public TransportContract $transport,
    )
    {
    }

    public function isSandbox(): bool
    {
        return $this->config->isSandbox();
    }

    public function option(string $key, mixed $default = null): mixed
    {
        return $this->config->option($key, $default);
    }

    public function secret(string $key, mixed $default = null): mixed
    {
        return $this->config->secret($key, $default);
    }
}
```

---
#### 3


` File: src/Driver/DriverManager.php`  [↑ Back to top](#index)

```php
<?php
declare(strict_types=1);

namespace Dgp\Sdk\Driver;

use Throwable;
use Dgp\Sdk\Support\Result;
use Dgp\Sdk\Support\DgpError;
use Dgp\Sdk\Support\DgpErrorCode;
use Dgp\Sdk\Support\Exceptions\RateLimitedException;
use Dgp\Sdk\Support\Exceptions\ValidationException;

final readonly class DriverManager
{
    public function __construct(
        private DriverResolver $resolver,
    ) {}

    public function resolve(string $key, DriverContext $context): object
    {
        return $this->resolver->resolve($key, $context);
    }

    /**
     * Boundary wrapper:
     * - expected business failures should be returned as Result::fail(DgpError)
     * - exceptions are internal/system/invariant and are converted here
     *
     * @template T
     * @param callable(): Result $fn
     * @return Result
     */
    public function call(callable $fn): Result
    {
        try {
            $res = $fn();

            // If someone returns something invalid, normalize to unknown.
            if (!$res instanceof Result) {
                return Result::fail(DgpError::unknown('Driver returned non-Result'));
            }

            return $res;
        } catch (RateLimitedException $e) {
            return Result::fail(new DgpError(
                DgpErrorCode::RATE_LIMITED,
                $e->getMessage(),
                null,
                null,
                null,
                $e->retryAfterSeconds,
            ));
        } catch (ValidationException $e) {
            return Result::fail(DgpError::fromThrowable($e, DgpErrorCode::VALIDATION_FAILED));
        } catch (Throwable $e) {
            return Result::fail(DgpError::fromThrowable($e, DgpErrorCode::UNKNOWN));
        }
    }
}
```

---
#### 4


` File: src/Driver/DriverRegistry.php`  [↑ Back to top](#index)

```php
<?php
declare(strict_types=1);

namespace Dgp\Sdk\Driver;

use Dgp\Sdk\Contracts\Driver\DriverLinkContract;
use Dgp\Sdk\Payloads\Common\DriverRegistration;
use Dgp\Sdk\Support\Exceptions\DgpException;
use Throwable;

final class DriverRegistry
{
    /** @var array<string, callable(DriverContext): object> */
    private array $factories = [];

    /** @var array<string, array<string, mixed>> */
    private array $meta = [];

    /** @var array<string, DriverRegistration> normalized handlerId => registration */
    private array $handlers = [];

    /**
     * Register a driver factory.
     *
     * @param callable(DriverContext): object $factory
     * @param array<string,mixed> $meta
     */
    public function registerDriver(string $driverKey, callable $factory, array $meta = []): void
    {
        $driverKey = $this->normalizeDriverKey($driverKey);

        if (isset($this->factories[$driverKey])) {
            throw new DgpException("Driver '$driverKey' already registered");
        }

        $this->factories[$driverKey] = $factory;
        $this->meta[$driverKey] = $meta;
    }

    /**
     * Register a handler entry (host-stored mapping).
     */
    public function registerHandler(DriverRegistration $registration): void
    {
        $driverKey = $this->normalizeDriverKey($registration->driverKey);

        if (!isset($this->factories[$driverKey])) {
            throw new DgpException("Cannot register handler: driver '$driverKey' is not registered.");
        }

        $linkClass = trim($registration->linkClass);

        if ($linkClass === '' || !class_exists($linkClass)) {
            throw new DgpException("DriverLink class '$linkClass' does not exist.");
        }

        if (!is_subclass_of($linkClass, DriverLinkContract::class)) {
            throw new DgpException("DriverLink class '$linkClass' must implement " . DriverLinkContract::class);
        }

        $k = $this->normalizeHandlerId($registration->handlerId);

        $this->handlers[$k] = new DriverRegistration(
            handlerId: $registration->handlerId,
            driverKey: $driverKey,
            linkClass: $linkClass,
            meta: $registration->meta,
        );
    }

    /** @return callable(DriverContext): object */
    public function factory(string $driverKey): callable
    {
        $driverKey = $this->normalizeDriverKey($driverKey);

        if (!isset($this->factories[$driverKey])) {
            throw new DgpException("Driver '$driverKey' is not registered");
        }

        return $this->factories[$driverKey];
    }

    public function hasDriver(string $driverKey): bool
    {
        return isset($this->factories[$this->normalizeDriverKey($driverKey)]);
    }

    public function getHandler(int|string $handlerId): ?DriverRegistration
    {
        return $this->handlers[$this->normalizeHandlerId($handlerId)] ?? null;
    }

    public function hasHandler(int|string $handlerId): bool
    {
        return isset($this->handlers[$this->normalizeHandlerId($handlerId)]);
    }

    /** @return array<string, array<string, mixed>> */
    public function metadata(): array
    {
        return $this->meta;
    }

    /** @return string[] */
    public function keys(): array
    {
        return array_keys($this->factories);
    }

    public function normalizeDriverKey(string $driverKey): string
    {
        $driverKey = trim($driverKey);
        if ($driverKey === '') {
            throw new DgpException('Driver key cannot be empty.');
        }
        return $driverKey;
    }

    private function normalizeHandlerId(int|string $id): string
    {
        return is_int($id) ? 'i:' . $id : 's:' . $id;
    }

    /**
     * Instantiate the link for a handlerId (PayKit-style provider instantiation).
     */
    public function makeLink(int|string $handlerId): DriverLinkContract
    {
        $reg = $this->getHandler($handlerId);

        if (!$reg) {
            throw new DgpException("Handler '$handlerId' is not registered in the DriverRegistry.");
        }

        $cls = $reg->linkClass;

        try {
            /** @var DriverLinkContract $link */
            $link = new $cls($handlerId);
            return $link;
        } catch (Throwable $e) {
            throw new DgpException(
                "Failed to instantiate DriverLink '$cls' for handler '$handlerId': {$e->getMessage()}",
                previous: $e
            );
        }
    }
}
```

---
#### 5


` File: src/Driver/DriverResolver.php`  [↑ Back to top](#index)

```php
<?php
declare(strict_types=1);

namespace Dgp\Sdk\Driver;

final readonly class DriverResolver
{
    public function __construct(
        private DriverRegistry $registry,
    ) {}

    public function resolve(string $key, DriverContext $context): object
    {
        $factory = $this->registry->factory($key);

        return $factory($context);
    }
}
```


---
*Generated with [Prodex](https://github.com/emxhive/prodex) — Codebase decoded.*
<!-- PRODEx v1.4.11 | 2026-01-25T02:30:48.802Z -->